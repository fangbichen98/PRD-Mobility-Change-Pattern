  # ä½ çš„train_improvedæ˜¯åœ¨trainåŸºç¡€ä¸Šæ”¹çš„å—ï¼Œæˆ‘ä¹‹å‰æœ‰æ ¹æ®ä¸€äº›é—®é¢˜è°ƒæ•´åˆ°run_improved_dual_year_experiment.py.backupæ–‡ä»¶ä¸­ï¼Œè¯·ä½ çœ‹çœ‹trainå’Œtrain_improvedæ˜¯å¦å­˜åœ¨ç±»ä¼¼çš„é—®  é¢˜ï¼Œç„¶åè·Ÿæˆ‘è®¨è®ºä¸€ä¸‹ã€‚ 

å¥½çš„ï¼è®­ç»ƒå®é™…ä¸Šåœ¨æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯è¢«ç³»ç»Ÿkilläº†ï¼ˆexit code 137é€šå¸¸æ˜¯å†…å­˜ä¸è¶³ï¼‰ã€‚ç°åœ¨è®©æˆ‘å¯¹æ¯”åˆ†æè¿™ä¸‰ä¸ªæ–‡ä»¶çš„å…³é”®å·®å¼‚å’Œæ½œåœ¨é—®é¢˜ã€‚

  ğŸ“Š ä¸‰ä¸ªæ–‡ä»¶çš„å¯¹æ¯”åˆ†æ

  1. æ–‡ä»¶æ¦‚è§ˆ
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    æ–‡ä»¶                     â”‚         ç”¨é€”         â”‚ æ•°æ®å¤„ç†æ–¹å¼ â”‚          æ¨¡å‹ç±»å‹           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ train.py                                    â”‚ å•å¹´è®­ç»ƒï¼ˆåŸå§‹ï¼‰     â”‚ å•å¹´ODæ•°æ®   â”‚ æ—§ç‰ˆæ¨¡å‹                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ train_improved.py                           â”‚ åŒå¹´è®­ç»ƒï¼ˆæ–°ç‰ˆç®€åŒ–ï¼‰ â”‚ åŒå¹´å¯¹æ¯”æ•°æ® â”‚ æ–°ç‰ˆImprovedDualBranchModel â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ run_improved_dual_year_experiment.py.backup â”‚ åŒå¹´è®­ç»ƒï¼ˆå®Œæ•´ç‰ˆï¼‰   â”‚ åŒå¹´å¯¹æ¯”æ•°æ® â”‚ æ—§ç‰ˆDualBranchSTModel       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ---
  2. å…³é”®å·®å¼‚å¯¹æ¯”

  A. æ•°æ®é›†ç±» (Dataset)

  run_improved_dual_year_experiment.py.backup:
  class ImprovedDualYearDataset(MobilityDataset):
      def __getitem__(self, idx):
          temporal_features = self.change_features[grid_id]  # (168, 10)
          spatial_features = temporal_features  # ä¸å±•å¹³ï¼Œä¿ç•™æ—¶é—´ç»“æ„
          return {
              'temporal': torch.FloatTensor(temporal_features),
              'spatial': torch.FloatTensor(spatial_features),  # (168, 10)
              'label': torch.LongTensor([label])[0],
              'grid_id': grid_id
          }

  train_improved.py:
  class ImprovedDualYearDataset:
      def __getitem__(self, idx):
          features = data['change_features'][grid_id]  # (7, 4)
          x_2021 = features[:, [0, 2]]  # [total_log, net_flow_log]
          x_2024 = features[:, [1, 3]]
          return {
              'x_2021': torch.FloatTensor(x_2021),  # (7, 2)
              'x_2024': torch.FloatTensor(x_2024),  # (7, 2)
              'label': torch.LongTensor([label])[0],
              'grid_id': grid_id
          }

  ğŸ”´ å…³é”®å·®å¼‚1ï¼šç‰¹å¾ç»´åº¦å®Œå…¨ä¸åŒï¼
  - backupç‰ˆæœ¬: (168, 10) - 168å°æ—¶ Ã— 10ç‰¹å¾
  - train_improvedç‰ˆæœ¬: (7, 2) - 7å¤© Ã— 2ç‰¹å¾ï¼ˆæ¯å¹´ï¼‰

  ---
  B. æ¨¡å‹è¾“å…¥

  run_improved_dual_year_experiment.py.backup:
  model = DualBranchSTModel(
      temporal_input_size=10,  # 10ç‰¹å¾/æ—¶é—´æ­¥
      spatial_input_size=10    # 10ç‰¹å¾/æ—¶é—´æ­¥
  )
  # è¾“å…¥: (batch, 168, 10) å’Œ (num_nodes, 168, 10)

  train_improved.py:
  model = ImprovedDualBranchModel(
      temporal_input_size=config.TEMPORAL_INPUT_SIZE,  # 2
      spatial_input_size=config.SPATIAL_INPUT_SIZE,    # 2
      num_time_steps=config.TIME_STEPS  # 7
  )
  # è¾“å…¥: (batch, 7, 2) å’Œ (num_nodes, 7, 2)

  ğŸ”´ å…³é”®å·®å¼‚2ï¼šæ¨¡å‹æ¶æ„ä¸åŒï¼
  - backup: ä½¿ç”¨æ—§ç‰ˆDualBranchSTModel
  - train_improved: ä½¿ç”¨æ–°ç‰ˆImprovedDualBranchModel

  ---
  C. æ•°æ®åŠ è½½å™¨ (DataLoader)

  run_improved_dual_year_experiment.py.backup:
  train_loader, val_loader, test_loader = create_data_loaders(
      dataset=dataset,
      edge_index=data['edge_index'],  # é™æ€å›¾
      edge_attr=data['edge_weights'],
      grid_id_to_idx=data['grid_id_to_idx'],
      batch_size=batch_size
  )

  train_improved.py:
  collator = ImprovedGraphBatchCollator(
      graphs_2021=data['graphs_2021'],  # åŠ¨æ€å›¾ï¼ˆ7ä¸ªå¿«ç…§ï¼‰
      graphs_2024=data['graphs_2024'],  # åŠ¨æ€å›¾ï¼ˆ7ä¸ªå¿«ç…§ï¼‰
      grid_id_to_idx=data['grid_id_to_idx'],
      all_features_2021=all_features_2021,
      all_features_2024=all_features_2024
  )

  ğŸ”´ å…³é”®å·®å¼‚3ï¼šå›¾ç»“æ„ä¸åŒï¼
  - backup: ä½¿ç”¨é™æ€å›¾ï¼ˆå•ä¸ªedge_indexï¼‰
  - train_improved: ä½¿ç”¨åŠ¨æ€å›¾ï¼ˆæ¯å¤©ä¸€ä¸ªå›¾ï¼Œå…±14ä¸ªï¼‰

  ---
  3. æ½œåœ¨é—®é¢˜åˆ†æ

  é—®é¢˜1: å†…å­˜å ç”¨ (Exit Code 137)

  train_improved.py çš„å†…å­˜é—®é¢˜ï¼š

  # æ¯ä¸ªbatchéœ€è¦ä¼ é€’ï¼š
  - graphs_2021: 7ä¸ªå›¾ Ã— 270ä¸‡æ¡è¾¹ = å·¨å¤§å†…å­˜
  - graphs_2024: 7ä¸ªå›¾ Ã— 270ä¸‡æ¡è¾¹ = å·¨å¤§å†…å­˜
  - all_features_2021: (9977, 7, 2) å…¨å›¾ç‰¹å¾
  - all_features_2024: (9977, 7, 2) å…¨å›¾ç‰¹å¾

  è®¡ç®—ï¼š
  - æ¯ä¸ªå›¾: 2,729,942æ¡è¾¹ Ã— 2 (edge_index) Ã— 8å­—èŠ‚ â‰ˆ 44 MB
  - 14ä¸ªå›¾: 44 MB Ã— 14 â‰ˆ 616 MB (ä»…å›¾ç»“æ„)
  - æ¯ä¸ªbatchéƒ½è¦å¤åˆ¶è¿™äº›å›¾åˆ°GPUï¼

  run_improved_dual_year_experiment.py.backup çš„ä¼˜åŠ¿ï¼š
  # åªä½¿ç”¨é™æ€å›¾ï¼š
  - edge_index: å•ä¸ªå›¾ Ã— 270ä¸‡æ¡è¾¹ â‰ˆ 44 MB
  - ä¸éœ€è¦æ¯ä¸ªbatchå¤åˆ¶å›¾

  ---
  é—®é¢˜2: è®¾å¤‡ä¼ è¾“ (æˆ‘ä»¬åˆšä¿®å¤çš„)

  train_improved.py çš„é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰ï¼š
  # å›¾æ•°æ®åœ¨CPUä¸Šï¼Œç‰¹å¾åœ¨GPUä¸Š
  graphs_2021 = batch['graphs_2021']  # CPU
  x_2021 = batch['all_features_2021'].to(device)  # GPU
  # âŒ å¯¼è‡´è®¾å¤‡ä¸åŒ¹é…é”™è¯¯

  ä¿®å¤åï¼š
  # ç§»åŠ¨å›¾æ•°æ®åˆ°GPU
  graphs_2021 = [(edge_index.to(device), edge_attr.to(device))
                 for edge_index, edge_attr in batch['graphs_2021']]

  ---
  é—®é¢˜3: Batch Size

  train_improved.py:
  batch_size = 2  # éå¸¸å°ï¼
  # åŸå› ï¼šæ¯ä¸ªbatchéœ€è¦ä¼ é€’14ä¸ªå®Œæ•´çš„å›¾

  run_improved_dual_year_experiment.py.backup:
  batch_size = 16  # æ›´åˆç†
  # åŸå› ï¼šåªä½¿ç”¨é™æ€å›¾ï¼Œå†…å­˜å ç”¨å°

  ---
  4. å»ºè®®å’Œè®¨è®º

  A. å…³äº train_improved.py çš„é—®é¢˜

  ä¼˜ç‚¹ï¼š
  âœ… ä½¿ç”¨åŠ¨æ€å›¾ï¼ˆæ¯å¤©ä¸€ä¸ªå›¾ï¼‰ï¼Œæ›´ç¬¦åˆæ—¶åºå»ºæ¨¡
  âœ… ä½¿ç”¨æ–°ç‰ˆImprovedDualBranchModel
  âœ… ç‰¹å¾åˆ†ç¦»ï¼ˆ2021å’Œ2024åˆ†å¼€ï¼‰

  ç¼ºç‚¹ï¼š
  âŒ å†…å­˜å ç”¨å·¨å¤§ï¼ˆæ¯ä¸ªbatchä¼ é€’14ä¸ªå®Œæ•´å›¾ï¼‰
  âŒ Batch sizeè¢«è¿«å¾ˆå°ï¼ˆbatch_size=2ï¼‰
  âŒ è®­ç»ƒé€Ÿåº¦æ…¢ï¼ˆæ¯ä¸ªbatch 6-7ç§’ï¼‰
  âŒ å®¹æ˜“OOMï¼ˆexit code 137ï¼‰

  B. å…³äº run_improved_dual_year_experiment.py.backup çš„ä¼˜åŠ¿

  ä¼˜ç‚¹ï¼š
  âœ… å†…å­˜æ•ˆç‡é«˜ï¼ˆåªä½¿ç”¨é™æ€å›¾ï¼‰
  âœ… Batch sizeæ›´å¤§ï¼ˆbatch_size=16ï¼‰
  âœ… è®­ç»ƒé€Ÿåº¦å¿«
  âœ… æ›´ç¨³å®šï¼ˆä¸å®¹æ˜“OOMï¼‰

  ç¼ºç‚¹ï¼š
  âŒ ä½¿ç”¨æ—§ç‰ˆDualBranchSTModel
  âŒ é™æ€å›¾æ— æ³•æ•æ‰æ—¶åºå˜åŒ–

  ---
  5. æ¨èæ–¹æ¡ˆ

  æˆ‘å»ºè®®ä½ è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé€‰é¡¹ï¼š

  é€‰é¡¹1: ä¼˜åŒ– train_improved.pyï¼ˆæ¨èï¼‰

  # ä¸è¦æ¯ä¸ªbatchä¼ é€’å®Œæ•´å›¾ï¼Œè€Œæ˜¯ï¼š
  1. å°†å›¾é¢„å…ˆç§»åŠ¨åˆ°GPUï¼ˆåˆå§‹åŒ–æ—¶ï¼‰
  2. æ¯ä¸ªbatchåªä¼ é€’node_indices
  3. åœ¨æ¨¡å‹å†…éƒ¨æå–å­å›¾

  é€‰é¡¹2: å›é€€åˆ° run_improved_dual_year_experiment.py.backup

  # å¦‚æœå†…å­˜æ˜¯ä¸»è¦é—®é¢˜ï¼š
  1. ä½¿ç”¨é™æ€å›¾ç‰ˆæœ¬
  2. Batch sizeå¯ä»¥å¢å¤§åˆ°16æˆ–32
  3. è®­ç»ƒæ›´ç¨³å®š

  é€‰é¡¹3: æ··åˆæ–¹æ¡ˆ

  # ç»“åˆä¸¤è€…ä¼˜ç‚¹ï¼š
  1. ä½¿ç”¨æ–°ç‰ˆImprovedDualBranchModel
  2. ä½†ä½¿ç”¨é™æ€å›¾ï¼ˆè€ŒéåŠ¨æ€å›¾ï¼‰
  3. åœ¨æ¨¡å‹å†…éƒ¨æ¨¡æ‹Ÿæ—¶åºå˜åŒ–

  ---
  6. å…·ä½“é—®é¢˜è®¨è®º

  ä½ æƒ³è®¨è®ºå“ªäº›æ–¹é¢ï¼Ÿ

  1. å†…å­˜ä¼˜åŒ–ï¼šå¦‚ä½•å‡å°‘train_improved.pyçš„å†…å­˜å ç”¨ï¼Ÿ
  2. æ¨¡å‹é€‰æ‹©ï¼šåº”è¯¥ç”¨å“ªä¸ªæ¨¡å‹ï¼ˆDualBranchSTModel vs ImprovedDualBranchModelï¼‰ï¼Ÿ
  3. å›¾ç»“æ„ï¼šåŠ¨æ€å›¾ vs é™æ€å›¾ï¼Œå“ªä¸ªæ›´é€‚åˆä½ çš„ä»»åŠ¡ï¼Ÿ
  4. ç‰¹å¾è®¾è®¡ï¼š(168, 10) vs (7, 2)ï¼Œå“ªä¸ªç‰¹å¾æ›´åˆç†ï¼Ÿ
  5. è®­ç»ƒç­–ç•¥ï¼šå¦‚ä½•å¹³è¡¡å†…å­˜ã€é€Ÿåº¦å’Œæ€§èƒ½ï¼Ÿ

  è¯·å‘Šè¯‰æˆ‘ä½ æœ€å…³å¿ƒå“ªäº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥è®¨è®ºï¼