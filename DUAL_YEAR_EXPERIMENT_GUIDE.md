# åŒå¹´ä»½å¯¹æ¯”å®éªŒè¯´æ˜

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒæ€è·¯

æœ¬é¡¹ç›®çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**å¯¹æ¯”2021å¹´å’Œ2024å¹´çš„äººç¾¤æµåŠ¨æ¨¡å¼å˜åŒ–ï¼Œå¹¶å¯¹å˜åŒ–ç±»å‹è¿›è¡Œåˆ†ç±»**

### æ­£ç¡®ç†è§£

- âœ… **è¾“å…¥**: 2021å¹´å’Œ2024å¹´çš„æµåŠ¨æ•°æ®
- âœ… **æ ‡ç­¾**: è¡¨ç¤ºæµåŠ¨æ¨¡å¼çš„**å˜åŒ–ç±»å‹**ï¼ˆ9ç±»ï¼‰
- âœ… **ç›®æ ‡**: åˆ†ç±»æ¯ä¸ªç½‘æ ¼çš„æµåŠ¨æ¨¡å¼å¦‚ä½•å˜åŒ–

### ä¹‹å‰çš„é”™è¯¯å®ç°

- âŒ `run_small_experiment.py` åªä½¿ç”¨äº†2021å¹´çš„æ•°æ®
- âŒ æ²¡æœ‰ä½“ç°2021 vs 2024çš„å¯¹æ¯”
- âŒ æ— æ³•æ•æ‰æ—¶é—´å˜åŒ–ç‰¹å¾

## ğŸ“Š æ–°çš„å®éªŒè®¾è®¡

### ç‰¹å¾è®¾è®¡

æ¯ä¸ªç½‘æ ¼çš„æ—¶é—´åºåˆ—ç‰¹å¾ç»´åº¦ï¼š**168å°æ—¶ Ã— 10ç‰¹å¾**

| ç‰¹å¾ç¼–å· | ç‰¹å¾åç§° | è¯´æ˜ |
|---------|---------|------|
| 1 | 2021å¹´æµå…¥é‡ | 2021å¹´æ¯å°æ—¶æµå…¥è¯¥ç½‘æ ¼çš„äººæ•° |
| 2 | 2021å¹´æµå‡ºé‡ | 2021å¹´æ¯å°æ—¶ä»è¯¥ç½‘æ ¼æµå‡ºçš„äººæ•° |
| 3 | 2024å¹´æµå…¥é‡ | 2024å¹´æ¯å°æ—¶æµå…¥è¯¥ç½‘æ ¼çš„äººæ•° |
| 4 | 2024å¹´æµå‡ºé‡ | 2024å¹´æ¯å°æ—¶ä»è¯¥ç½‘æ ¼æµå‡ºçš„äººæ•° |
| 5 | æµå…¥é‡å˜åŒ– | 2024æµå…¥ - 2021æµå…¥ |
| 6 | æµå‡ºé‡å˜åŒ– | 2024æµå‡º - 2021æµå‡º |
| 7 | æµå…¥é‡ç›¸å¯¹å˜åŒ–ç‡ | (2024æµå…¥ - 2021æµå…¥) / 2021æµå…¥ |
| 8 | æµå‡ºé‡ç›¸å¯¹å˜åŒ–ç‡ | (2024æµå‡º - 2021æµå‡º) / 2021æµå‡º |
| 9 | 2021å¹´æ€»æµé‡ | 2021å¹´æµå…¥ + 2021å¹´æµå‡º |
| 10 | 2024å¹´æ€»æµé‡ | 2024å¹´æµå…¥ + 2024å¹´æµå‡º |

### åŒåˆ†æ”¯ç‰¹å¾ä½¿ç”¨

**é‡è¦è¯´æ˜**ï¼šæ—¶é—´åºåˆ—åˆ†æ”¯ï¼ˆLSTMï¼‰å’ŒåŠ¨æ€å›¾åˆ†æ”¯ï¼ˆDySATï¼‰ä½¿ç”¨**ç›¸åŒçš„10ä¸ªç‰¹å¾**ï¼Œåªæ˜¯è¾“å…¥æ ¼å¼ä¸åŒï¼š

- **æ—¶é—´åºåˆ—åˆ†æ”¯ï¼ˆLSTMï¼‰**ï¼šæ¥æ”¶ `(168, 10)` çš„æ—¶é—´åºåˆ—æ•°æ®
  - ä¿ç•™æ—¶é—´ç»´åº¦ï¼Œæ•æ‰æ—¶åºä¾èµ–å…³ç³»
  - é€šè¿‡åŒå‘LSTMå¤„ç†æ—¶é—´åºåˆ—æ¨¡å¼

- **åŠ¨æ€å›¾åˆ†æ”¯ï¼ˆDySATï¼‰**ï¼šæ¥æ”¶ `(1680,)` çš„å±•å¹³ç‰¹å¾å‘é‡
  - å°†æ—¶é—´åºåˆ—å±•å¹³ä¸ºä¸€ç»´å‘é‡
  - é€šè¿‡å›¾æ³¨æ„åŠ›ç½‘ç»œæ•æ‰ç©ºé—´ä¾èµ–å…³ç³»

- **ç‰¹å¾èåˆ**ï¼šä¸¤ä¸ªåˆ†æ”¯çš„è¾“å‡ºé€šè¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶èåˆ
  - å­¦ä¹ æ—¶ç©ºç‰¹å¾çš„è‡ªé€‚åº”æƒé‡
  - ç»“åˆæ—¶åºæ¨¡å¼å’Œç©ºé—´å…³ç³»è¿›è¡Œåˆ†ç±»

### æ•°æ®å¤„ç†æµç¨‹

```
2021.csv (12.7GB)  â”€â”€â”
                     â”œâ”€â”€> æ—¶é—´å¯¹é½ â”€â”€> ç‰¹å¾æå– â”€â”€> å˜åŒ–è®¡ç®— â”€â”€> æ¨¡å‹è®­ç»ƒ
2024.csv (12.9GB)  â”€â”€â”˜
```

1. **åŠ è½½ä¸¤å¹´æ•°æ®**: åˆ†åˆ«åŠ è½½2021å’Œ2024å¹´çš„ODæµåŠ¨æ•°æ®
2. **æ—¶é—´å¯¹é½**: ä½¿ç”¨ç›¸åŒçš„æ—¶é—´çª—å£ï¼ˆå‰7å¤©ï¼Œ168å°æ—¶ï¼‰
3. **æµé‡èšåˆ**: è®¡ç®—æ¯ä¸ªç½‘æ ¼æ¯å°æ—¶çš„æµå…¥/æµå‡ºé‡
4. **å˜åŒ–è®¡ç®—**: è®¡ç®—ç»å¯¹å˜åŒ–å’Œç›¸å¯¹å˜åŒ–
5. **ç‰¹å¾ç»„åˆ**: å°†8ä¸ªç‰¹å¾ç»„åˆæˆæ—¶é—´åºåˆ—

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡ŒåŒå¹´ä»½å®éªŒ

```bash
python run_dual_year_experiment.py
```

### è‡ªå®šä¹‰å‚æ•°

ç¼–è¾‘ `run_dual_year_experiment.py`:

```python
exp_manager, results = run_dual_year_experiment(
    experiment_name="dual_year_2021vs2024",
    model_type='dual_branch',
    samples_per_class=100,
    num_epochs=50,
    batch_size=16,
    device='cpu'
)
```

### è¾“å‡ºç»“æ„

```
outputs/
â””â”€â”€ dual_year_2021vs2024_{timestamp}/
    â”œâ”€â”€ EXPERIMENT_SUMMARY.txt          # å®éªŒæ€»ç»“
    â”œâ”€â”€ DUAL_YEAR_SUMMARY.txt           # åŒå¹´ä»½ç‰¹å®šæ€»ç»“
    â”œâ”€â”€ config.json                     # é…ç½®ï¼ˆåŒ…å«ç‰¹å¾è¯´æ˜ï¼‰
    â”œâ”€â”€ logs/experiment.log             # å®Œæ•´æ—¥å¿—
    â”œâ”€â”€ models/best_model.pth           # æœ€ä½³æ¨¡å‹
    â”œâ”€â”€ figures/
    â”‚   â”œâ”€â”€ training_curves.jpg         # è®­ç»ƒæ›²çº¿
    â”‚   â”œâ”€â”€ confusion_matrix.jpg        # æ··æ·†çŸ©é˜µ
    â”‚   â”œâ”€â”€ true_labels.jpg             # çœŸå®å˜åŒ–ç±»å‹åˆ†å¸ƒ
    â”‚   â”œâ”€â”€ predicted_labels.jpg        # é¢„æµ‹å˜åŒ–ç±»å‹åˆ†å¸ƒ
    â”‚   â”œâ”€â”€ class_temporal_patterns_2021.jpg  # 2021å¹´æ—¶é—´æ¨¡å¼
    â”‚   â””â”€â”€ class_temporal_patterns_2024.jpg  # 2024å¹´æ—¶é—´æ¨¡å¼
    â”œâ”€â”€ metrics/
    â”‚   â”œâ”€â”€ training_history.json       # è®­ç»ƒå†å²
    â”‚   â””â”€â”€ test_results.json           # æµ‹è¯•ç»“æœ
    â””â”€â”€ data/
        â””â”€â”€ labels_sampled.csv          # é‡‡æ ·æ ‡ç­¾
```

## ğŸ“ˆ ä¸å•å¹´ä»½å®éªŒçš„å¯¹æ¯”

### å•å¹´ä»½å®éªŒ (run_small_experiment.py)

```python
# âŒ é”™è¯¯çš„å®ç°
ç‰¹å¾ç»´åº¦: 168å°æ—¶ Ã— 2ç‰¹å¾
ç‰¹å¾å†…å®¹: [æµå…¥é‡, æµå‡ºé‡]
æ•°æ®æ¥æº: ä»…2021å¹´
é—®é¢˜: æ— æ³•ä½“ç°æ—¶é—´å˜åŒ–
```

### åŒå¹´ä»½å®éªŒ (run_dual_year_experiment.py)

```python
# âœ… æ­£ç¡®çš„å®ç°
ç‰¹å¾ç»´åº¦: 168å°æ—¶ Ã— 10ç‰¹å¾
ç‰¹å¾å†…å®¹: [2021æµå…¥, 2021æµå‡º, 2024æµå…¥, 2024æµå‡º,
          å˜åŒ–æµå…¥, å˜åŒ–æµå‡º, ç›¸å¯¹å˜åŒ–æµå…¥, ç›¸å¯¹å˜åŒ–æµå‡º,
          2021æ€»æµé‡, 2024æ€»æµé‡]
æ•°æ®æ¥æº: 2021å¹´ + 2024å¹´
ä¼˜åŠ¿: å®Œæ•´æ•æ‰æ—¶é—´å˜åŒ–æ¨¡å¼
```

## ğŸ”§ æŠ€æœ¯å®ç°

### æ–°å¢æ–‡ä»¶

1. **`src/preprocessing/dual_year_processor.py`**
   - `DualYearDataProcessor` ç±»ï¼šå¤„ç†åŒå¹´ä»½æ•°æ®
   - `prepare_dual_year_experiment_data()` å‡½æ•°ï¼šå‡†å¤‡å®Œæ•´æ•°æ®é›†

2. **`run_dual_year_experiment.py`**
   - `DualYearDataset` ç±»ï¼šåŒå¹´ä»½æ•°æ®é›†
   - `run_dual_year_experiment()` å‡½æ•°ï¼šè¿è¡Œå®Œæ•´å®éªŒ

### æ ¸å¿ƒä»£ç 

```python
# è®¡ç®—å˜åŒ–ç‰¹å¾
def compute_temporal_change_features(flows_2021, flows_2024):
    """è®¡ç®—2021å’Œ2024å¹´ä¹‹é—´çš„å˜åŒ–ç‰¹å¾"""

    flow_2021 = flows_2021[grid_id]  # (168, 2)
    flow_2024 = flows_2024[grid_id]  # (168, 2)

    # ç»å¯¹å˜åŒ–
    diff = flow_2024 - flow_2021

    # ç›¸å¯¹å˜åŒ–
    rel_change = diff / (np.abs(flow_2021) + epsilon)

    # æ€»æµé‡
    total_2021 = flow_2021.sum(axis=1, keepdims=True)  # (168, 1)
    total_2024 = flow_2024.sum(axis=1, keepdims=True)  # (168, 1)

    # ç»„åˆç‰¹å¾: [2021, 2024, diff, rel_change, total_2021, total_2024]
    combined = np.concatenate([
        flow_2021,      # (168, 2)
        flow_2024,      # (168, 2)
        diff,           # (168, 2)
        rel_change,     # (168, 2)
        total_2021,     # (168, 1)
        total_2024      # (168, 1)
    ], axis=1)  # (168, 10)

    return combined
```

## ğŸ“Š é¢„æœŸæ”¹è¿›

ä½¿ç”¨åŒå¹´ä»½æ•°æ®åï¼Œé¢„æœŸæ¨¡å‹æ€§èƒ½ä¼šæœ‰æ˜¾è‘—æå‡ï¼š

### å•å¹´ä»½å®éªŒç»“æœ
- æµ‹è¯•å‡†ç¡®ç‡: 25.56%
- æµ‹è¯•F1åˆ†æ•°: 0.1761
- é—®é¢˜: ä¸¥é‡è¿‡æ‹Ÿåˆï¼Œæ³›åŒ–èƒ½åŠ›å·®

### åŒå¹´ä»½å®éªŒé¢„æœŸ
- âœ… æ›´ä¸°å¯Œçš„ç‰¹å¾ï¼ˆ10ä¸ª vs 2ä¸ªï¼‰
- âœ… ç›´æ¥å»ºæ¨¡å˜åŒ–æ¨¡å¼
- âœ… æ›´ç¬¦åˆé¡¹ç›®ç›®æ ‡
- âœ… é¢„æœŸæ€§èƒ½æå‡

## ğŸ¯ å®éªŒå»ºè®®

### 1. åŸºç¡€å®éªŒ
```bash
# è¿è¡ŒåŒå¹´ä»½åŸºç¡€å®éªŒ
python run_dual_year_experiment.py
```

### 2. å¯¹æ¯”å®éªŒ
```bash
# å¯¹æ¯”å•å¹´ä»½ vs åŒå¹´ä»½
# å•å¹´ä»½
python run_small_experiment.py

# åŒå¹´ä»½
python run_dual_year_experiment.py

# å¯¹æ¯”ç»“æœ
python compare_experiments.py
```

### 3. æ¶ˆèå®éªŒ
æµ‹è¯•ä¸åŒç‰¹å¾ç»„åˆçš„æ•ˆæœï¼š
- åªç”¨2021å’Œ2024åŸå§‹æ•°æ®ï¼ˆ4ç‰¹å¾ï¼‰
- åªç”¨å˜åŒ–é‡ï¼ˆ2ç‰¹å¾ï¼‰
- åªç”¨ç›¸å¯¹å˜åŒ–ç‡ï¼ˆ2ç‰¹å¾ï¼‰
- åªç”¨æ€»æµé‡ï¼ˆ2ç‰¹å¾ï¼‰
- å®Œæ•´ç‰¹å¾ï¼ˆ10ç‰¹å¾ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

### æ•°æ®è¦æ±‚
- âœ… éœ€è¦2021.csvå’Œ2024.csvä¸¤ä¸ªæ–‡ä»¶
- âœ… ä¸¤å¹´æ•°æ®çš„æ—¶é—´çª—å£éœ€è¦å¯¹é½
- âœ… ç½‘æ ¼IDéœ€è¦åœ¨ä¸¤å¹´ä¸­éƒ½å­˜åœ¨

### è®¡ç®—èµ„æº
- åŒå¹´ä»½æ•°æ®é‡æ˜¯å•å¹´ä»½çš„2å€
- ç‰¹å¾ç»´åº¦å¢åŠ 5å€ï¼ˆ2â†’10ï¼‰
- å»ºè®®ä½¿ç”¨GPUåŠ é€Ÿè®­ç»ƒ

### æ¨¡å‹é€‚é…
- âœ… æ¨¡å‹å·²æ”¯æŒå¯å˜è¾“å…¥ç»´åº¦
- âœ… `temporal_input_size=10`
- âœ… `spatial_input_size=168*10=1680`

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»å•å¹´ä»½è¿ç§»åˆ°åŒå¹´ä»½

1. **ä½¿ç”¨æ–°çš„æ•°æ®å¤„ç†å™¨**
```python
from src.preprocessing.dual_year_processor import prepare_dual_year_experiment_data

# æ›¿ä»£åŸæ¥çš„ prepare_data()
data = prepare_dual_year_experiment_data(
    label_path='data/labels_1w.csv',
    samples_per_class=100
)
```

2. **ä½¿ç”¨æ–°çš„æ•°æ®é›†ç±»**
```python
from run_dual_year_experiment import DualYearDataset

# æ›¿ä»£åŸæ¥çš„ MobilityDataset
dataset = DualYearDataset(
    change_features=data['change_features'],
    labels=data['labels'],
    grid_ids=list(data['labels'].keys())
)
```

3. **è°ƒæ•´æ¨¡å‹è¾“å…¥ç»´åº¦**
```python
model = DualBranchSTModel(
    temporal_input_size=10,      # ä»2æ”¹ä¸º10
    spatial_input_size=168 * 10  # ä»336æ”¹ä¸º1680
)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **CLAUDE.md** - é¡¹ç›®æ€»ä½“è¯´æ˜
- **EXPERIMENT_MANAGEMENT_GUIDE.md** - å®éªŒç®¡ç†æŒ‡å—
- **QUICK_START.md** - å¿«é€Ÿå¼€å§‹
- **æœ¬æ–‡æ¡£** - åŒå¹´ä»½å®éªŒè¯´æ˜

## âœ… æ€»ç»“

- âœ… æ–°çš„å®éªŒæ­£ç¡®å®ç°äº†é¡¹ç›®æ ¸å¿ƒæ€è·¯
- âœ… ä½¿ç”¨2021å’Œ2024å¹´æ•°æ®è¿›è¡Œå¯¹æ¯”
- âœ… ç‰¹å¾åŒ…å«åŸå§‹æ•°æ®å’Œå˜åŒ–é‡
- âœ… æ ‡ç­¾è¡¨ç¤ºæµåŠ¨æ¨¡å¼å˜åŒ–ç±»å‹
- âœ… å®Œæ•´çš„å®éªŒç®¡ç†ç³»ç»Ÿ

**å»ºè®®**: ä»ç°åœ¨å¼€å§‹ä½¿ç”¨ `run_dual_year_experiment.py` è¿›è¡Œæ‰€æœ‰å®éªŒï¼
